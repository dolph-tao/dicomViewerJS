<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test01</title>
    <link href="./css/dicom-viewer.css" rel="stylesheet" type="text/css"/>
    <link href="./css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <script src='js/inflate.min.js'></script>
    <script src="./js/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="./js/three.min.js" type="text/javascript"></script>
    <script src="js/TrackballControls.js"></script>
    <script src="js/Detector.js"></script>
    <script src="js/stats.min.js"></script>
    <script src="js/VTKLoader.js"></script>
</head>
<body>
<div id="container"></div>
<div><p class="info"></p></div>
<div id="events" class="threeEvents">
    <div class="icon3D icon-mouseup col-lg-6 col-sm-6 threeIcons" id="measure"
         style="background:url(image/icon/meature.png);background-size:contain;" data-original-title="长度测量"
         data-placement="bottom">
    </div>
    <div class="icon3D icon-mouseup col-lg-6 col-sm-6 threeIcons" id="return"
         style="background:url(image/icon/revoked.png);background-size:contain;" data-original-title="重绘图像"
         data-placement="bottom">
    </div>
</div>
<div class="threeLength"></div>
<div class="col-lg-3 col-sm-3" style="right: 30px;top: 20px;position: absolute;">
    <div class="input-group">
        <input type="text" class="form-control" style="height: 40px;" placeholder="请输入病历号">
        <span class="input-group-btn">
                <button class="btn btn-default" type="button" style="height: 40px;">查询</button>
            </span>
    </div><!-- /input-group -->
</div><!-- /.col-lg-6 -->
</body>
<script>
    $(document).ready(function () {
        var container, stats, events;
        var clickStatus, line;
        var camera, controls, scene, renderer;

        init();
        animate();

        function init() {

            //initialize icon mouse event,按钮效果
            $('#events').find('.icon3D').mousedown(function () {
                $(this).removeClass("icon-mouseup").addClass("icon-mousedown");
            }).mouseup(function () {
                $(this).removeClass("icon-mousedown").addClass("icon-mouseup");
            });//这个是鼠标键，是你鼠标左击按下的的效果

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.z = 50;
            camera.lookAt({x: 0, y: 0, z: 0});

            controls = new THREE.TrackballControls(camera);

            controls.rotateSpeed = 3.0;
            controls.zoomSpeed = 2.0;
            controls.panSpeed = 2.0;

            controls.noZoom = false;
            controls.noPan = false;

            controls.staticMoving = true;
            controls.dynamicDampingFactor = 0.3;

            controls.keys = [65, 83, 68];

            controls.addEventListener('change', render);

            // world

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);
            var material = new THREE.MeshLambertMaterial({color: 0xFF7D40, side: THREE.DoubleSide});
            var loader = new THREE.VTKLoader();
            loader.load("./image/vtk/1.chenhuaguo_100.vtk", function (geometry) {
                geometry.center();
                geometry.computeVertexNormals();
                var mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(-0.075, 0.005, 0);
                mesh.scale.multiplyScalar(0.2);
                scene.add(mesh);
            });
            // lights
            var light;
            light = new THREE.DirectionalLight(0xffffff);
            light.position.set(1, 1, 1);
            scene.add(light);

            light = new THREE.DirectionalLight(0xffffff);
            light.position.set(-1, -1, -1);
            scene.add(light);

            light = new THREE.AmbientLight(0x888888);
            scene.add(light);


            // renderer

            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setClearColor(scene.fog.color);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);

            container = document.getElementById('container');
            container.appendChild(renderer.domElement);

            stats = new Stats();
            stats.domElement.style.position = 'absolute'; //绝对坐标
            stats.domElement.style.left = '0px';// (0,0)px,左上角
            stats.domElement.style.top = '0px';
            document.getElementById('container').appendChild(stats.domElement);

            //
            events = document.getElementById("events");
            var axes = new THREE.AxisHelper(30);
            scene.add(axes);
            //
            window.addEventListener('resize', onWindowResize, false);
            //
            render();
            $('#measure').click(function () {
                clickStatus = 1;
                statusChange();
                var seg = [];
                var segStatus = 0;
                $('#container').click(function (event) {
                    event.preventDefault();
                    var vector = new THREE.Vector3();//三维坐标对象
                    vector.set(
                        ( event.clientX / window.innerWidth ) * 2 - 1,
                        -( event.clientY / window.innerHeight ) * 2 + 1,
                        0.5);
                    vector.unproject(camera);
                    var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
                    var intersects = raycaster.intersectObjects(scene.children);
                    if (intersects.length > 0) {
                        var selected = intersects[0];//取第一个物体
                        if(segStatus == 0){
                            segStatus= 1 ;
                            seg[0]=[selected.point.x,selected.point.y,selected.point.z];
                            scene.remove(line);
                            $('.threeLength')[0].innerHTML = null;
                        }
                        else if(segStatus){
                            segStatus = 0;
                            seg[1]=[selected.point.x,selected.point.y,selected.point.z];
                            var material = new THREE.LineBasicMaterial({
                                color: 0xffffff
                            });

                            var geometry = new THREE.Geometry();
                            geometry.vertices.push(
                                new THREE.Vector3((seg[0])[0],(seg[0])[1],(seg[0])[2]),
                                new THREE.Vector3((seg[1])[0],(seg[1])[1],(seg[1])[2])
                            );

                            line = new THREE.Line( geometry, material );
                            scene.add( line );
                            var length = Math.sqrt(((seg[0])[0]-(seg[1])[0])*((seg[0])[0]-(seg[1])[0])+((seg[0])[1]-(seg[1])[1])*((seg[0])[1]-(seg[1])[1])+((seg[0])[2]-(seg[1])[2])*((seg[0])[2]-(seg[1])[2]))*4.42;
                            $('.threeLength')[0].innerHTML = "<p>length:"+length.toFixed(2)+"mm</p>";
                        }
                    }
                });

            });
            $('#return').click(function () {
                clickStatus = 0;
                statusChange();
                scene.remove(line);
            })
        }

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);

            controls.handleResize();

            render();

        }

        function animate() {

            requestAnimationFrame(animate);
            controls.update();
            render();
        }

        function render() {

            renderer.render(scene, camera);
            stats.update();

        }
        function statusChange(){
            if(clickStatus != 1){
                $('#container').off("click");
                $('.threeLength')[0].innerHTML = null;
            }
        }
//        function onDocumentMouseDown( event ) {
//            event.preventDefault();
//            var vector = new THREE.Vector3();//三维坐标对象
//            vector.set(
//                ( event.clientX / window.innerWidth ) * 2 - 1,
//                - ( event.clientY / window.innerHeight ) * 2 + 1,
//                0.5 );
//            vector.unproject( camera );
//            var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
//            var intersects = raycaster.intersectObjects(scene.children);
//            if (intersects.length > 0) {
//                var selected = intersects[0];//取第一个物体
//                console.log("x坐标:"+selected.point.x);
//                console.log("y坐标:"+selected.point.y);
//                console.log("z坐标:"+selected.point.z);
//            }
//        }


    });
</script>
</html>